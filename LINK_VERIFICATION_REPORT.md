# 🔍 アフィリエイトリンク精度検証レポート

## 📊 設定済み2店舗の詳細検証

### ✅ **店舗1: ル・パン・コティディアン**

| 項目 | データベース | 食べログ実際 | 一致度 |
|------|-------------|-------------|--------|
| 店舗名 | ル・パン・コティディアン | ル・パン・コティディアン 東京ミッドタウン店 | ✅ 一致 |
| 住所 | 東京都港区赤坂9丁目7-1 東京ミッドタウンプラザ1F | 東京都港区赤坂9-7-3 ミッドタウン･ウエスト プラザ 1F | ⚠️ 微妙に異なる |
| 食べログURL | https://tabelog.com/tokyo/A1307/A130701/13209416/ | 同じ | ✅ 正確 |
| 営業状況 | - | 営業中（07:30-22:00） | ✅ 営業中 |

**判定**: ✅ **正しくマッチング済み**（住所は表記揺れの範囲内）

---

### ❌ **店舗2: かおたんラーメンえんとつ屋 南青山店**

| 項目 | データベース | 食べログ実際 | 一致度 |
|------|-------------|-------------|--------|
| 店舗名 | かおたんラーメンえんとつ屋 南青山店 | かおたんラーメンえんとつ屋 南青山店 | ✅ 一致 |
| 住所 | 東京都港区南青山2-27-18 パサージュ青山2F | 東京都港区南青山2-34-30 | ❌ **完全に異なる** |
| 食べログURL | https://tabelog.com/tokyo/A1307/A130701/13001896/ | 同じ | ✅ 正確 |
| 営業状況 | - | 営業中 | ✅ 営業中 |

**判定**: ❌ **誤ったマッチング！**（住所が全く異なる店舗）

---

## 🚨 **問題の分析**

### **精度の課題**
1. **店舗名だけでの検索**では同名の別店舗がヒットする可能性
2. **住所の表記揺れ**により正確な照合が困難
3. **チェーン店・支店**の区別が曖昧

### **現在の成功率**
- 正確: 1/2店舗 (50%)
- 誤マッチング: 1/2店舗 (50%)

**→ このままでは184店舗中92店舗が間違ったリンクになる可能性**

---

## 🎯 **精度を向上させる手法**

### **手法1: 多段階検証（推奨）**

#### Step 1: 基本検索
```bash
# 店舗名 + 住所の主要部分で検索
Google検索: "店舗名 + 区市町村名 + 食べログ"
```

#### Step 2: 住所照合
```bash
# 食べログページの住所とDBの住所を比較
- 番地レベルでの照合
- 建物名の違いは許容
- 区・市レベルでの不一致は除外
```

#### Step 3: 人間による最終確認
```bash
# 疑わしいケースは人間が判定
- 住所の不一致度が高い場合
- 複数候補がある場合
- チェーン店で複数店舗がある場合
```

### **手法2: 高精度自動化**

#### 住所マッチング改善
```javascript
function calculateAddressMatch(dbAddress, tabelogAddress) {
  // 1. 区・市レベルの一致 (必須)
  // 2. 丁目レベルの一致 (重要) 
  // 3. 番地の近似一致 (許容範囲内)
  // 4. 建物名の類似度 (参考)
  
  return matchScore; // 0-100の信頼度
}
```

#### 多重検索戦略
```bash
# 検索クエリのパターンを増やす
1. "店舗名 住所" + 食べログ
2. "店舗名 最寄り駅" + 食べログ  
3. "店舗名 建物名" + 食べログ
4. "店舗名のみ" + 食べログ + 手動フィルタリング
```

### **手法3: 信頼度ベース設定**

```bash
信頼度90%以上: 自動設定
信頼度70-89%: 要人間確認
信頼度70%未満: スキップ
```

---

## 💡 **実装改善案**

### **即座に修正すべき問題**
```bash
# かおたんラーメンの誤リンクを修正
npx tsx scripts/manual-affiliate-setup.ts --action fix-wrong-link \
  --location-id bdb0a2d5-36fc-4c87-a872-ba986ed227ba \
  --correct-address "東京都港区南青山2-27-18"
```

### **検索精度向上スクリプト**
```typescript
interface VerificationResult {
  confidence: number; // 0-100
  addressMatch: boolean;
  distanceKm: number;
  reasons: string[];
}

async function verifyLocationMatch(
  dbLocation: Location,
  tabelogUrl: string
): Promise<VerificationResult> {
  // 1. 食べログページから住所取得
  // 2. 住所の類似度計算
  // 3. 地理的距離の計算
  // 4. 総合信頼度の算出
}
```

### **手動確認ワークフロー**
```bash
# 疑わしいケースのCSV出力
npx tsx scripts/generate-verification-needed.ts
# → verification-needed.csv

# CSVを確認して人間が判定
# → verified-links.csv

# 確認済みリンクを一括設定
npx tsx scripts/apply-verified-links.ts verified-links.csv
```

---

## 🚀 **推奨アクションプラン**

### **今すぐやること**
1. **かおたんラーメンの誤リンクを修正**
2. **検証スクリプトの実装**  
3. **TOP5店舗を高精度で再設定**

### **来週やること**
1. **住所マッチングアルゴリズムの改善**
2. **信頼度ベースの自動化実装**
3. **TOP20店舗の精密設定**

### **成功指標**
- **精度目標**: 95%以上（184店舗中175店舗以上が正確）
- **効率目標**: 1店舗あたり5分以内での設定
- **信頼度**: 人間による最終確認での品質保証

**まずは誤リンクの修正から始めましょう！** 🔧